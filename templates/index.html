
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boltz (v2.2.0) Webapp</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', 'Helvetica', 'Arial', sans-serif;
    }
    .error { color: #E53E3E; }
    .success { color: #234E52; }
    .info { color: #5A67D8; }
    .btn-primary {
      background: linear-gradient(to bottom, #2C7A7B, #2A6A6B);
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .btn-primary:hover {
      background: #234E52;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: linear-gradient(to bottom, #5A67D8, #4C51BF);
      transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .btn-secondary:hover {
      background: #434190;
      transform: translateY(-1px);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #5A67D8;
      box-shadow: 0 0 0 2px rgba(90, 103, 216, 0.5);
    }
    .container-shadow {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    /* Add checkbox focus style for consistency */
    input[type="checkbox"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(90, 103, 216, 0.5);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50 text-gray-800 font-sans">
  <main class="flex-grow p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl p-6 md:p-8 space-y-6 container-shadow">
      <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800">Boltz (v2.2.0) Webapp</h1>
      <h2 class="text-xl md:text-2xl font-semibold text-center text-gray-600">Biomolecular Complex Prediction (Protein, DNA, RNA & Small Molecules)</h2>
      <form id="sequence-form" class="space-y-6">
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">Primary Sequence <span class="text-red-600">(Required)</span></h3>
          <select name="primary_type" required class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="protein">Protein Sequence</option>
            <option value="dna">DNA Sequence</option>
            <option value="rna">RNA Sequence</option>
            <option value="smiles">SMILES String</option>
          </select>
          <textarea name="primary_sequence" rows="5" required class="w-full mt-2 p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2 text-gray-800">Additional Inputs <span class="text-gray-500">(Optional)</span></h3>
          <div id="additional-inputs" class="space-y-4">
            <div class="input-group flex flex-col md:flex-row md:items-start gap-3">
              <select name="input_type[]" class="w-full md:w-1/3 p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <option value="protein">Protein Sequence</option>
                <option value="dna">DNA Sequence</option>
                <option value="rna">RNA Sequence</option>
                <option value="smiles">SMILES String</option>
              </select>
              <textarea name="additional_input[]" rows="3" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
              <button type="button" class="remove-input bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Remove</button>
            </div>
          </div>
          <button type="button" id="add-input" class="mt-3 btn-primary text-white px-4 py-2 rounded-lg">Add Input</button>
        </div>
        <!-- Added Checkbox for Use Physical Potentials -->
        <div class="flex items-center gap-3">
          <input type="checkbox" name="use_physical_potentials" id="use_physical_potentials" class="h-5 w-5 text-indigo-500 border-gray-200 rounded focus:ring-2 focus:ring-indigo-500">
          <label for="use_physical_potentials" class="text-gray-800 font-medium">Use Physical Potentials</label>
        </div>
        <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg text-lg font-semibold">Run Prediction</button>
      </form>
      <div>
        <h3 class="text-lg font-semibold mt-6 text-gray-800">Status</h3>
        <pre id="status-output" class="whitespace-pre-wrap bg-gray-100 p-4 border border-gray-200 rounded-lg max-h-64 overflow-y-auto text-sm text-gray-700">Waiting for submission...</pre>
      </div>
      <div id="download-link" class="hidden mt-6">
        <h3 class="text-lg font-semibold mb-2 text-gray-800">Download Results</h3>
        <div class="flex flex-wrap gap-3">
          <a id="download-cif-btn" href="#" class="download-btn hidden btn-secondary text-white px-4 py-2 rounded-lg">Download CIF File</a>
          <a id="download-zip-btn" href="#" class="download-btn btn-secondary text-white px-4 py-2 rounded-lg">Download All Files (ZIP)</a>
          <a id="download-log-btn" href="#" class="download-btn btn-secondary text-white px-4 py-2 rounded-lg">Download Log File</a>
        </div>
      </div>
    </div>
  </main>
  <footer class="flex-shrink-0 w-full text-center text-sm text-gray-600 bg-gray-100 border-t border-gray-200 py-3">
    <p class="mb-1">
      If you use complexes generated with this tool for publications, posters, or presentations,  
      please cite the following publications and acknowledge Dr. Peter Stockinger for providing access to this web app.
    </p>
    <p class="mb-0.5 text-sm">
      Mirdita et al. (2022). <em>ColabFold: Making protein folding accessible to all</em>. 
      <a href="https://www.nature.com/articles/s41592-022-01488-1" target="_blank" class="text-indigo-500 hover:text-indigo-600 underline">Nature Methods</a>.
    </p>
    <p class="mb-0.5 text-sm">
      Wohlwend et al. (2024). <em>Boltz-1: Democratizing biomolecular interaction modeling</em>. 
      <a href="https://doi.org/10.1101/2024.11.19.624167" target="_blank" class="text-indigo-500 hover:text-indigo-600 underline">bioRxiv</a>.
    </p>
    <p class="mb-0.5 text-sm">
      Passaro et al. (2025). <em>Boltz-2: Towards Accurate and Efficient Binding Affinity Prediction</em>. 
      <a href="https://www.biorxiv.org/content/10.1101/2025.06.14.659707v1n" target="_blank" class="text-indigo-500 hover:text-indigo-600 underline">bioRxiv</a>.
    </p>    
    <div class="flex justify-center items-center space-x-2 text-gray-500">
      <span>Â© Dr. Peter Stockinger</span>
      <a href="https://www.linkedin.com/in/peter-stockinger/" target="_blank" rel="noopener noreferrer" class="hover:text-indigo-600">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-4 h-4 inline-block" viewBox="0 0 24 24">
          <path d="M20.447 20.452h-3.554v-5.569c0-1.327-.025-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.94v5.666H9.351V9h3.414v1.561h.049c.476-.9 1.637-1.852 3.369-1.852 3.6 0 4.266 2.37 4.266 5.451v6.292zM5.337 7.433c-1.144 0-2.07-.928-2.07-2.07 0-1.145.926-2.07 2.07-2.07s2.07.925 2.07 2.07c0 1.142-.926 2.07-2.07 2.07zM6.814 20.452H3.861V9h2.953v11.452zM22.225 0H1.771C.792 0 0 .771 0 1.729v20.542C0 23.229.792 24 1.771 24h20.451C23.207 24 24 23.229 24 22.271V1.729C24 .771 23.207 0 22.225 0z"/>
        </svg>
      </a>
    </div>
  </footer>
  <script>
    let currentTimestamp = null;

    $('#add-input').click(function() {
      const newInput = `
        <div class="input-group flex flex-col md:flex-row md:items-start gap-3 mt-2">
          <select name="input_type[]" class="w-full md:w-1/3 p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="protein">Protein Sequence</option>
            <option value="dna">DNA Sequence</option>
            <option value="rna">RNA Sequence</option>
            <option value="smiles">SMILES String</option>
          </select>
          <textarea name="additional_input[]" rows="3" class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
          <button type="button" class="remove-input bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Remove</button>
        </div>`;
      $('#additional-inputs').append(newInput);
    });

    $(document).on('click', '.remove-input', function() {
      $(this).parent().remove();
    });

    $('#sequence-form').submit(function(e) {
      e.preventDefault();
      console.log("Submitting form...");
      $('#status-output').html('Prediction started...\n');
      $('#download-link').hide();
      $('#download-cif-btn').hide();
      
      $.ajax({
        url: '/submit',
        type: 'POST',
        data: $(this).serialize(),
        success: function(response) {
          console.log("Submit response:", response);
          if (response.error) {
            $('#status-output').html(`<span class="error">${response.error}</span>`);
            console.error("Submission error:", response.error);
            return;
          }
          
          currentTimestamp = response.timestamp;
          $('#download-cif-btn').attr('href', `/download_cif/${currentTimestamp}`);
          $('#download-zip-btn').attr('href', `/download_zip/${currentTimestamp}`);
          $('#download-log-btn').attr('href', `/download_log/${currentTimestamp}`);
          
          const interval = setInterval(function() {
            $.get(`/status/${currentTimestamp}`, function(data) {
              console.log("Status update:", data.status);
              const filteredStatuses = Array.isArray(data.status) ? data.status.filter(msg => !msg.includes('No updates yet')) : [];
              const formattedStatuses = filteredStatuses.map(msg => {
                if (msg.startsWith('Error:')) {
                  return `<span class="error">${msg}</span>`;
                } else if (msg.startsWith('Info:')) {
                  return `<span class="info">${msg}</span>`;
                } else if (msg.includes('successfully') || msg.includes('completed')) {
                  return `<span class="success">${msg}</span>`;
                }
                return msg;
              });
              $('#status-output').html(formattedStatuses.join('\n') || 'Prediction in progress...');
              
              if (data.status && (data.status.some(s => s.includes('CIF file created')) || 
                  data.status.includes(`download_ready:${currentTimestamp}`))) {
                clearInterval(interval);
                $('#download-link').show();
                $('#download-cif-btn').show();
              } else if (data.status && data.status.some(s => s.startsWith('Error:'))) {
                if (data.status.some(s =>
                  s.includes('MSA server') ||
                  s.includes('GPU access') ||
                  s.includes('timed out') ||
                  s.includes('return code'))) {
                  clearInterval(interval);
                  $('#download-link').show();
                  $('#download-zip-btn').show();
                  $('#download-log-btn').show();
                }
              }
            }).fail(function(jqXHR, textStatus, errorThrown) {
              console.error("Status fetch error:", textStatus, errorThrown);
              let errorMsg = 'Error fetching status';
              if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                errorMsg = jqXHR.responseJSON.error;
              }
              $('#status-output').html(`<span class="error">${errorMsg}</span>`);
              clearInterval(interval);
              $('#download-link').show();
              $('#download-zip-btn').show();
              $('#download-log-btn').show();
            });
          }, 2000);
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.error("Submit error:", textStatus, errorThrown);
          let errorMsg = 'Error submitting form';
          if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
            errorMsg = jqXHR.responseJSON.error;
          }
          $('#status-output').html(`<span class="error">${errorMsg}</span>`);
        }
      });
    });
  </script>
</body>
</html>
